name: PR Status Update

on:
  workflow_run:
    workflows: ["PR Quality Checks"]
    types:
      - completed

jobs:
  update-status:
    name: Update PR Status
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      actions: read

    steps:
      - name: Update PR with workflow status
        uses: actions/github-script@v7
        with:
          script: |
            const workflowRun = context.payload.workflow_run;
            const conclusion = workflowRun.conclusion;
            const runUrl = workflowRun.html_url;
            
            // Get associated PRs
            const { data: prs } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: workflowRun.head_sha
            });
            
            if (prs.length === 0) return;
            
            const prNumber = prs[0].number;
            
            let emoji = 'âœ…';
            let status = 'passed';
            let message = 'All quality checks have passed! Your code looks great! ðŸŽ‰';
            
            if (conclusion === 'failure') {
              emoji = 'âŒ';
              status = 'failed';
              message = 'Some quality checks failed. Please review the errors and fix them.';
            } else if (conclusion === 'cancelled') {
              emoji = 'âš ï¸';
              status = 'cancelled';
              message = 'Quality checks were cancelled.';
            } else if (conclusion === 'skipped') {
              emoji = 'â­ï¸';
              status = 'skipped';
              message = 'Quality checks were skipped.';
            }
            
            const comment = `## ${emoji} Quality Checks ${status.toUpperCase()}
            
            ${message}
            
            [View workflow run details](${runUrl})
            
            ---
            *Automated checks completed at ${new Date().toUTCString()}*`;
            
            // Check if we already commented
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            
            const botComments = comments.filter(c => 
              c.user.type === 'Bot' && 
              c.body.includes('Quality Checks')
            );
            
            if (botComments.length > 0) {
              // Update the last bot comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComments[botComments.length - 1].id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
            }
